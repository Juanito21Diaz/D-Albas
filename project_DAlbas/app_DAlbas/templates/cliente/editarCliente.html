{% extends "index.html" %}

{% block encabezado %}
    {% include "cliente/encabezado.html" %}
{% endblock %}

{% block contenido %}
<br><br>
<div>
    <h1 class="heading"> Editar <span>información</span></h1>
</div>
<br>
<div class="container mt-5 mb-5">
    <form action="/actualizarClientes/" method="post" id="frmUpdateCliente" autocomplete="off" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="row gutters">
            <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12">
            <div class="card edit h-100">
                <div class="card-body">
                    <div class="account-settings">
                        <div class="row mx-1">
                            <div class="col-12 col-md-12 col-lg-12 mx-auto mb-3 text-center">
                                <div class="mt-5 mb-4">
                                    <img class="rounded" id="imagenProducto" src="/media/{{cliente.fotoUsuario}}" alt="Foto de perfil">
                                </div>
                                <div class="container-input">
                                    <input type="file" id="fileFoto" name="fileFoto" accept=".jpg"
                                        class="inputfile inputfile-1"
                                        data-multiple-caption="{count} archivos seleccionados" multiple />
                                    <label for="fileFoto">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="iborrainputfile" width="20"
                                            height="17" viewBox="0 0 20 17">
                                            <path
                                                d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z">
                                            </path>
                                        </svg>
                                        <span class="iborrainputfile" id="btnSubirImagen">Subir imagen</span>
                                    </label>
                                </div>
                                <div class="m-4">
                                    <label for="fileFoto">Cambiar imagen de perfil</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <div class="col-xl-9 col-lg-9 col-md-12 col-sm-12 col-12">
            <div class="card edit h-100">
                <div class="card-body mx-4">
                    <div class="row gutters">
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 mt-4 mb-4">
                            <h4 class="mb-2 text-primary">Datos personales</h4>
                        </div>
                        <hr class="mb-4">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtNombre">Nombres del cliente:</label>
                                <input type="text" class="form-control" id="txtNombre" name="txtNombre" value="{{cliente.first_name}}" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtApellido">Apellidos del cliente:</label>
                                <input type="text" class="form-control" id="txtApellido" name="txtApellido" value="{{cliente.last_name}}" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtIdentificacion">Número de identificación:</label>
                                <input type="number" class="form-control" id="txtIdentificacion" name="txtIdentificacion" value="{{cliente.identificacionCliente}}" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtTelefono">Número telefonico:</label>
                                <input type="tel" class="form-control" id="txtTelefono" name="txtTelefono" value="{{cliente.telefonoCliente}}" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtCorreo">Correo electronico:</label>
                                <input type="email" class="form-control" id="txtCorreo" name="txtCorreo" value="{{cliente.email}}" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4">
                            <div class="form-group">
                                <label for="txtCorreoConfirmado">Confirmar correo electronico:</label>
                                <input type="text" class="form-control" id="txtCorreoConfirmado" name="txtCorreoConfirmado" placeholder="Confirme su correo electronico" value="{{cliente.email}}" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4" id="contenedorContrasena" style="display: none;">
                            <label for="txtPassword">Contraseña nueva:</label>
                            <div class="form-group input-group">
                                <input type="password" class="form-control" id="txtPassword" name="txtPassword" placeholder="Ingrese una contraseña nueva" autocomplete="off" required>
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" value="" id="verPassword1" aria-label="Checkbox for following text input">
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6 col-12 mb-4" id="contenedorConfirmarContrasena" style="display: none;">
                            <label for="txtPasswordConfirmada">Confirmar contraseña:</label>
                            <div class="form-group input-group">
                                <input type="password" class="form-control" id="txtPasswordConfirmada" name="txtPasswordConfirmada" placeholder="confirme su contraseña" autocomplete="off" required>
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" value="" id="verPassword2" aria-label="Checkbox for following text input">
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="idCliente" id="idCliente" value="{{cliente.id}}">
                    </div>
                    <div class="row gutters">
                        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 mt-4 mb-4 d-flex align-items-end justify-content-end">
                            <div class="text-right">
                                <button type="button" class="btn btn-secondary" id="btnCambiarContrasena">Cambiar contraseña</button>
                                <button type="submit" class="btn btn-primary">Update</button>
                                <a href="/vistaPerfilUsuario/" type="button" class="btn btn-danger">Cancel</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            </div>
    </form>
</div>
<br><br><br><br><br>
<div>
    {% if mensaje %}
        {% if estado %}
            <script>
                Swal.fire("Editar datos", '{{mensaje}}', "success")
            </script>
        {% else %}
            <script>
                Swal.fire("Editar datos", '{{mensaje}}', "warning")
            </script>
        {% endif %}
    {% endif %}
</div>
<script>
    const btnCambiarContrasena = document.querySelector('#btnCambiarContrasena');
    const contenedorContrasena = document.querySelector('#contenedorContrasena');
    const contenedorConfirmarContrasena = document.querySelector('#contenedorConfirmarContrasena');
    const passwordInput1 = document.querySelector('#txtPassword');
    const showPasswordCheckbox1 = document.querySelector('#verPassword1');
    const passwordInput2 = document.querySelector('#txtPasswordConfirmada');
    const showPasswordCheckbox2 = document.querySelector('#verPassword2');

    btnCambiarContrasena.addEventListener('click', () => {
        if (contenedorContrasena.style.display === 'none') {
            Swal.fire({
                title: "Confirmar",
                text: "¿Desea cambiar su contraseña?",
                icon: "info",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: "Sí",
                cancelButtonText: "No"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mostrar los campos de contraseña
                    contenedorContrasena.style.display = 'block';
                    contenedorConfirmarContrasena.style.display = 'block';
                    btnCambiarContrasena.textContent = 'Ocultar';
                }
            });
        } else {
            // Ocultar los campos de contraseña
            contenedorContrasena.style.display = 'none';
            contenedorConfirmarContrasena.style.display = 'none';
            btnCambiarContrasena.textContent = 'Cambiar contraseña';
        }
    });

    showPasswordCheckbox1.addEventListener('change', () => {
        if (showPasswordCheckbox1.checked) {
            passwordInput1.type = 'text';
        } else {
            passwordInput1.type = 'password';
        }
    });

    showPasswordCheckbox2.addEventListener('change', () => {
        if (showPasswordCheckbox2.checked) {
            passwordInput2.type = 'text';
        } else {
            passwordInput2.type = 'password';
        }
    });

    document.getElementById("btnSubirImagen").addEventListener("click", function(e) {
        e.preventDefault();
        
        Swal.fire({
            title: "Confirmar",
            text: "¿Desea cambiar tu imagen de perfil?",
            icon: "info",
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: "Sí",
            cancelButtonText: "No"
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("fileFoto").click();
            }
        });
    });

    $(document).ready(function() {
        $("#frmUpdateCliente").submit(function(event) {
            event.preventDefault();
            
            var correo = $("#txtCorreo").val();
            var correoConfirmado = $("#txtCorreoConfirmado").val();
            
            if (correo !== correoConfirmado) {
                Swal.fire("Error", "Los correos electrónicos no coinciden", "warning");
                return;
            }

            var correoValido = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
            if (!correoValido.test(correo)) {
                Swal.fire("Error", "Por favor, ingrese un correo electrónico válido", "warning");
                return;
            }

            var contrasena = $("#txtPassword").val()
            var contrasenaConfirmada = $("#txtPasswordConfirmada").val()

            if (contrasena !== contrasenaConfirmada) {
                Swal.fire("Error", "Las contraseñas no coinciden", "warning");
                return;
            }
    
            var identificacion = $("#txtIdentificacion").val();
            if (isNaN(identificacion) || identificacion.length !== 10) {
                Swal.fire("Error", "La identificación debe tener exactamente 10 dígitos numéricos", "warning");
                return;
            }
    
            var nombre = $("#txtNombre").val();
            var apellido = $("#txtApellido").val();
            if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(nombre) || !/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(apellido)) {
                Swal.fire("Error", "Los campos de nombre y apellido no deben contener números ni caracteres especiales", "warning");
                return;
            }
    
            var archivoInput = $("#fileFoto");
            var archivo = archivoInput[0].files[0];
            if (archivo) {
                var fileSize = archivo.size;
                if (fileSize > 5 * 1024 * 1024) {
                    Swal.fire("Error", "La imagen debe ser menor a 5 MB", "warning");
                    return;
                }
                var fileType = archivo.type;
                if (fileType !== "image/jpeg" && fileType !== "image/jpg") {
                    Swal.fire("Error", "La imagen debe ser un archivo JPEG", "warning");
                    return;
                }
            }
    
            this.submit();
        });
    });
    </script>
{% endblock %}

{% block footer %}
{% include "cliente/footer.html" %}
{% endblock %}